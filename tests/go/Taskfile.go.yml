# MANAGED BY fredrikaverpil/github - DO NOT EDIT
# This file is automatically updated during sync operations
# Source: https://github.com/fredrikaverpil/github

version: '3'

vars:
  ROOT_DIR:
    sh: git rev-parse --show-toplevel
  # Tool versions
  # renovate: datasource=go depName=github.com/daixiang0/gci
  GCI_VERSION: v0.13.7
  # renovate: datasource=go depName=mvdan.cc/gofumpt
  GOFUMPT_VERSION: v0.9.2
  # renovate: datasource=go depName=golang.org/x/tools packageName=golang.org/x/tools/cmd/goimports
  GOIMPORTS_VERSION: v0.40.0
  # renovate: datasource=go depName=github.com/golangci/golangci-lint packageName=github.com/golangci/golangci-lint/v2/cmd/golangci-lint
  GOLANGCI_LINT_VERSION: v2.7.2
  # renovate: datasource=go depName=github.com/segmentio/golines
  GOLINES_VERSION: v0.13.0
  # renovate: datasource=go depName=golang.org/x/vuln packageName=golang.org/x/vuln/cmd/govulncheck
  GOVULNCHECK_VERSION: v1.1.4

tasks:
  default:
    desc: List all available tasks for Go
    cmds:
      - task -t Taskfile.go.yml --list

  format:
    desc: Format with goimports, gci, gofumpt and golines
    cmds:
      - |
        if [ -n "$(find . -name "*.go" -not -path "./vendor/*" -print -quit)" ]; then
          go run golang.org/x/tools/cmd/goimports@{{.GOIMPORTS_VERSION}} -w .
          go run github.com/daixiang0/gci@{{.GCI_VERSION}} write --skip-generated --skip-vendor -s standard -s default .
          go run mvdan.cc/gofumpt@{{.GOFUMPT_VERSION}} -extra -w .
          go run github.com/segmentio/golines@{{.GOLINES_VERSION}} --ignore-generated --tab-len=1 --max-len=120 --write-output .
          git diff --color=always --exit-code
        else
          echo "No Go files found, skipping format"
        fi

  golangci-lint:
    desc: Lint with golangci-lint
    aliases: ["lint"]
    cmds:
      - '[ -n "$(find . -name "*.go" -not -path "./vendor/*" -print -quit)" ] && go run github.com/golangci/golangci-lint/v2/cmd/golangci-lint@{{.GOLANGCI_LINT_VERSION}} --config {{ .ROOT_DIR }}/.golangci.yml run -v ./... || echo "No Go files found, skipping golangci-lint"'

  govulncheck:
    desc: Check vulnerabilities with govulncheck
    cmds:
      - '[ -n "$(find . -name "*.go" -not -path "./vendor/*" -print -quit)" ] && go run golang.org/x/vuln/cmd/govulncheck@{{.GOVULNCHECK_VERSION}} ./... || echo "No Go files found, skipping govulncheck"'

  go-test:
    desc: Run go test
    aliases: ["test"]
    cmds:
      - '[ -n "$(find . -name "*_test.go" -not -path "./vendor/*" -print -quit)" ] && go test ./... || echo "No Go test files found, skipping go test"'

  go-vet:
    desc: Run go vet
    cmds:
      - '[ -n "$(find . -name "*.go" -not -path "./vendor/*" -print -quit)" ] && go vet ./... || echo "No Go files found, skipping go vet"'

  gopls:
    # NOTE: could potentially attempt quickfixes?
    # gopls codeaction -w -exec -kind=quickfix <filename1.go> <filename2.go> ...
    desc: Check for gopls errors
    cmds:
      - '[ -n "$(find . -name "*.go" -not -path "./vendor/*" -print -quit)" ] && { task ensure-gopls; gopls stats; find . -name "*.go" | xargs -P $(nproc) gopls check; } || echo "No Go files found, skipping gopls check"'

  install-gopls:
    desc: Install gopls from latest version
    aliases: ["install"]
    cmds:
      - go install golang.org/x/tools/gopls@latest

  install-tools:
    desc: Install all Go tools
    cmds:
      - go install golang.org/x/tools/cmd/goimports@{{.GOIMPORTS_VERSION}}
      - go install github.com/daixiang0/gci@{{.GCI_VERSION}}
      - go install mvdan.cc/gofumpt@{{.GOFUMPT_VERSION}}
      - go install github.com/segmentio/golines@{{.GOLINES_VERSION}}
      - go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@{{.GOLANGCI_LINT_VERSION}}
      - go install golang.org/x/vuln/cmd/govulncheck@{{.GOVULNCHECK_VERSION}}

  ensure-gopls:
    internal: true
    status:
      - which gopls >/dev/null 2>&1
    cmds:
      - task: install-gopls
