#!/bin/bash
set -e

# Resolve shim directory to find .pocket
SHIM_DIR="$(cd "$(dirname "$0")" && pwd)"

POCKET_DIR="$SHIM_DIR/.pocket"
TASK_SCOPE="."
GO_VERSION="1.25.7"
GO_INSTALL_DIR="$POCKET_DIR/tools/go/$GO_VERSION"
GO_BIN="$GO_INSTALL_DIR/go/bin/go"

# Find Go binary
if command -v go &> /dev/null; then
    GO_CMD="go"
elif [[ -x "$GO_BIN" ]]; then
    GO_CMD="$GO_BIN"
else
    # Download Go
    echo "Go not found, downloading go$GO_VERSION..."
    OS=$(uname -s | tr '[:upper:]' '[:lower:]')
    ARCH=$(uname -m)
    [[ "$ARCH" == "x86_64" ]] && ARCH="amd64"
    [[ "$ARCH" == "aarch64" || "$ARCH" == "arm64" ]] && ARCH="arm64"

    # Get expected checksum for this platform
    EXPECTED_SHA256=""
    case "${OS}-${ARCH}" in
        "aix-ppc64") EXPECTED_SHA256="81bf2a1f20633f62d55d826d82dde3b0570cf1408a91e15781b266037299285b" ;;
        "darwin-amd64") EXPECTED_SHA256="bf5050a2152f4053837b886e8d9640c829dbacbc3370f913351eb0904cb706f5" ;;
        "darwin-arm64") EXPECTED_SHA256="ff18369ffad05c57d5bed888b660b31385f3c913670a83ef557cdfd98ea9ae1b" ;;
        "dragonfly-amd64") EXPECTED_SHA256="c5dccd7f192dd7b305dc209fb316ac1917776d74bd8e4d532ef2772f305bf42a" ;;
        "freebsd-386") EXPECTED_SHA256="a2de97c8ac74bf64b0ae73fe9d379e61af530e061bc7f8f825044172ffe61a8b" ;;
        "freebsd-amd64") EXPECTED_SHA256="055f9e138787dcafa81eb0314c8ff70c6dd0f6dba1e8a6957fef5d5efd1ab8fd" ;;
        "freebsd-arm") EXPECTED_SHA256="60e7f7a7c990f0b9539ac8ed668155746997d404643a4eecd47b3dee1b7e710b" ;;
        "freebsd-arm64") EXPECTED_SHA256="631e03d5fd4c526e2f499154d8c6bf4cb081afb2fff171c428722afc9539d53a" ;;
        "freebsd-riscv64") EXPECTED_SHA256="8a264fd685823808140672812e3ad9c43f6ad59444c0dc14cdd3a1351839ddd5" ;;
        "illumos-amd64") EXPECTED_SHA256="57c672447d906a1bcab98f2b11492d54521a791aacbb4994a25169e59cbe289a" ;;
        "linux-386") EXPECTED_SHA256="2866517e9ca81e6a2e85a930e9b11bc8a05cfeb2fc6dc6cb2765e7fb3c14b715" ;;
        "linux-amd64") EXPECTED_SHA256="12e6d6a191091ae27dc31f6efc630e3a3b8ba409baf3573d955b196fdf086005" ;;
        "linux-arm64") EXPECTED_SHA256="ba611a53534135a81067240eff9508cd7e256c560edd5d8c2fef54f083c07129" ;;
        "linux-armv6l") EXPECTED_SHA256="1ba07e0eb86b839e72467f4b5c7a5597d07f30bcf5563c951410454f7cda5266" ;;
        "linux-loong64") EXPECTED_SHA256="775753fc5952a334c415f08768df2f0b73a3228a16e8f5f63d545daacb4e3357" ;;
        "linux-mips") EXPECTED_SHA256="1a023bb367c5fbb4c637a2f6dc23ff17c6591ad929ce16ea88c74d857153b307" ;;
        "linux-mips64") EXPECTED_SHA256="a8e97223d8aa6fdfd45f132a4784d2f536bbac5f3d63a24b63d33b6bfe1549af" ;;
        "linux-mips64le") EXPECTED_SHA256="eb9edb6223330d5e20275667c65dea076b064c08e595fe4eba5d7d6055cfaccf" ;;
        "linux-mipsle") EXPECTED_SHA256="9c1e693552a5f9bb9e0012d1c5e01456ecefbc59bef53a77305222ce10aba368" ;;
        "linux-ppc64") EXPECTED_SHA256="28a788798e7329acbbc0ac2caa5e4368b1e5ede646cc24429c991214cfb45c63" ;;
        "linux-ppc64le") EXPECTED_SHA256="42124c0edc92464e2b37b2d7fcd3658f0c47ebd6a098732415a522be8cb88e3f" ;;
        "linux-riscv64") EXPECTED_SHA256="88d59c6893c8425875d6eef8e3434bc2fa2552e5ad4c058c6cd8cd710a0301c8" ;;
        "linux-s390x") EXPECTED_SHA256="c6b77facf666dc68195ecab05dbf0ebb4e755b2a8b7734c759880557f1c29b0c" ;;
        "netbsd-386") EXPECTED_SHA256="f14c184d9ade0ee04c7735d4071257b90896ecbde1b32adae84135f055e6399b" ;;
        "netbsd-amd64") EXPECTED_SHA256="7e7389e404dca1088c31f0fc07f1dd60891d7182bcd621469c14f7e79eceb3ff" ;;
        "netbsd-arm") EXPECTED_SHA256="70388bb3ef2f03dbf1357e9056bd09034a67e018262557354f8cf549766b3f9d" ;;
        "netbsd-arm64") EXPECTED_SHA256="8c1cda9d25bfc9b18d24d5f95fc23949dd3ff99fa408a6cfa40e2cf12b07e362" ;;
        "openbsd-386") EXPECTED_SHA256="42f0d1bfbe39b8401cccb84dd66b30795b97bfc9620dfdc17c5cd4fcf6495cb0" ;;
        "openbsd-amd64") EXPECTED_SHA256="e514879c0a28bc32123cd52c4c093de912477fe83f36a6d07517d066ef55391a" ;;
        "openbsd-arm") EXPECTED_SHA256="8cd22530695a0218232bf7efea8f162df1697a3106942ac4129b8c3de39ce4ef" ;;
        "openbsd-arm64") EXPECTED_SHA256="938720f6ebc0d1c53d7840321d3a31f29fd02496e84a6538f442a9311dc1cc9a" ;;
        "openbsd-ppc64") EXPECTED_SHA256="a4c378b73b98f89a3596c2ef51aabbb28783d9ca29f7e317d8ca07939660ce6f" ;;
        "openbsd-riscv64") EXPECTED_SHA256="937b58734fbeaa8c7941a0e4285e7e84b7885396e8d11c23f9ab1a8ff10ff20e" ;;
        "plan9-386") EXPECTED_SHA256="61a093c8c5244916f25740316386bb9f141545dcf01b06a79d1c78ece488403e" ;;
        "plan9-amd64") EXPECTED_SHA256="7fc8f6689c9de8ccb7689d2278035fa83c2d601409101840df6ddfe09ba58699" ;;
        "plan9-arm") EXPECTED_SHA256="9661dff8eaeeb62f1c3aadbc5ff189a2e6744e1ec885e32dbcb438f58a34def5" ;;
        "solaris-amd64") EXPECTED_SHA256="28ecba0e1d7950c8b29a4a04962dd49c3bf5221f55a44f17d98f369f82859cf4" ;;
        "windows-386") EXPECTED_SHA256="baa6b488291801642fa620026169e38bec2da2ac187cd3ae2145721cf826bbc3" ;;
        "windows-amd64") EXPECTED_SHA256="c75e5f4ff62d085cc0017be3ad19d5536f46825fa05db06ec468941f847e3228" ;;
        "windows-arm64") EXPECTED_SHA256="807033f85931bc4a589ca8497535dcbeb1f30d506e47fa200f5f04c4a71c3d9f" ;;
    esac

    DOWNLOAD_URL="https://go.dev/dl/go${GO_VERSION}.${OS}-${ARCH}.tar.gz"
    DOWNLOAD_FILE=$(mktemp)
    trap 'rm -f "$DOWNLOAD_FILE"' EXIT

    curl -fsSL "$DOWNLOAD_URL" -o "$DOWNLOAD_FILE"

    # Verify checksum if we have an expected value and a tool to compute it
    if [[ -n "$EXPECTED_SHA256" ]]; then
        ACTUAL_SHA256=""
        if command -v sha256sum &> /dev/null; then
            ACTUAL_SHA256=$(sha256sum "$DOWNLOAD_FILE" | cut -d' ' -f1)
        elif command -v shasum &> /dev/null; then
            ACTUAL_SHA256=$(shasum -a 256 "$DOWNLOAD_FILE" | cut -d' ' -f1)
        elif command -v openssl &> /dev/null; then
            ACTUAL_SHA256=$(openssl dgst -sha256 "$DOWNLOAD_FILE" | awk '{print $NF}')
        fi

        if [[ -n "$ACTUAL_SHA256" ]]; then
            if [[ "$ACTUAL_SHA256" != "$EXPECTED_SHA256" ]]; then
                echo "Checksum verification failed!" >&2
                echo "Expected: $EXPECTED_SHA256" >&2
                echo "Actual:   $ACTUAL_SHA256" >&2
                exit 1
            fi
            echo "Checksum verified."
        else
            echo "Warning: No checksum tool available (sha256sum, shasum, or openssl), skipping verification."
        fi
    else
        echo "Warning: No checksum available for ${OS}-${ARCH}, skipping verification."
    fi

    mkdir -p "$GO_INSTALL_DIR"
    tar -xzf "$DOWNLOAD_FILE" -C "$GO_INSTALL_DIR"
    GO_CMD="$GO_BIN"
    echo "Go $GO_VERSION installed to $GO_INSTALL_DIR"
fi

TASK_SCOPE="$TASK_SCOPE" "$GO_CMD" run -C "$POCKET_DIR" . "$@"
